<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å¤å¢³å†ç™ºè¦‹ã‚¢ãƒ—ãƒª</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 30px;
    }
    .instructions {
      background: #e8f4fd;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      border-left: 4px solid #3498db;
    }
    .upload-form {
      text-align: center;
      margin-bottom: 30px;
    }
    .file-input {
      margin: 20px 0;
    }
    .submit-btn {
      background: #3498db;
      color: white;
      padding: 12px 30px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
    }
    .submit-btn:hover {
      background: #2980b9;
    }
    .result-section {
      margin-top: 30px;
    }
    .result-image {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .detection-info {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }
    .detection-item {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      border-left: 4px solid #27ae60;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .detection-item:hover {
      transform: translateX(5px);
    }
    .confidence-high {
      border-left-color: #e74c3c;
      background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
    }
    .confidence-medium {
      border-left-color: #f39c12;
      background: linear-gradient(135deg, #fff8e1 0%, #ffffff 100%);
    }
    .confidence-low {
      border-left-color: #f1c40f;
      background: linear-gradient(135deg, #fffde7 0%, #ffffff 100%);
    }
    .no-detection {
      background: #fff3cd;
      padding: 15px;
      border-radius: 5px;
      border-left: 4px solid #ffc107;
      text-align: center;
    }
    .coordinates {
      font-family: monospace;
      background: #f1f2f6;
      padding: 8px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .error {
      color: #e74c3c;
      background: #fdf2f2;
      padding: 15px;
      border-radius: 5px;
      border-left: 4px solid #e74c3c;
    }
    .loading {
      color: #3498db;
      font-weight: bold;
      text-align: center;
      padding: 20px;
    }
    .stats {
      display: flex;
      justify-content: space-around;
      margin: 20px 0;
      flex-wrap: wrap;
    }
    .stat-item {
      text-align: center;
      padding: 15px;
      background: #ecf0f1;
      border-radius: 8px;
      min-width: 120px;
      margin: 5px;
    }
    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: #2c3e50;
    }
    .stat-label {
      color: #7f8c8d;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ›ï¸ å¤å¢³å†ç™ºè¦‹ã‚¢ãƒ—ãƒªï¼ˆYOLOv5ï¼‰</h2>
    
    <div class="instructions">
      <strong>ä½¿ã„æ–¹ï¼š</strong><br><br>
      ï¼‘ï¼å›½åœŸåœ°ç†é™¢ã‚µã‚¤ãƒˆã‹ã‚‰XMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™<br>
      ï¼’ï¼ã€Œxmlãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã§XMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¾ã™<br>
      ï¼“ï¼ã€Œæ¨è«–å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¾ã™<br>
      ï¼”ï¼å¤å¢³ã®å¯èƒ½æ€§ãŒã‚ã‚‹ç®‡æ‰€ãŒç”»åƒä¸Šã«è¡¨ç¤ºã•ã‚Œã¾ã™
    </div>

    <form method="post" enctype="multipart/form-data" action="/upload" onsubmit="return onSubmitForm();" class="upload-form">
      <label for="xmlFile">xmlãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label><br>
      <input type="file" name="file" id="xmlFile" accept=".xml" required class="file-input"><br>
      <button type="submit" class="submit-btn">æ¨è«–å®Ÿè¡Œ</button>
    </form>

    <div id="loading-message" style="display:none;" class="loading">
      ğŸ” æ¨è«–ä¸­ã§ã™â€¦å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚
    </div>

    {% if result_path %}
      <div class="result-section">
        <h3>æ¨è«–çµæœç”»åƒ</h3>
        <img src="{{ result_path }}" alt="æ¨è«–çµæœ" class="result-image">
        
        {% if result_info %}
          <div class="detection-info">
            <h4>æ¤œå‡ºçµæœ</h4>
            
            {% if result_info.has_kofun %}
              <div class="stats">
                <div class="stat-item">
                  <div class="stat-number">{{ result_info.total_detections }}</div>
                  <div class="stat-label">æ¤œå‡ºæ•°</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number">âœ…</div>
                  <div class="stat-label">å¤å¢³ã‚ã‚Š</div>
                </div>
              </div>
              
              {% for detection in result_info.detections %}
                {% set confidence = detection.confidence if detection.confidence else 0 %}
                {% if confidence >= 0.3 %}
                  {% set confidence_class = "confidence-high" %}
                {% elif confidence >= 0.2 %}
                  {% set confidence_class = "confidence-medium" %}
                {% else %}
                  {% set confidence_class = "confidence-low" %}
                {% endif %}
                
                <div class="detection-item {{ confidence_class }}">
                  <strong>ğŸ” æ¤œå‡º #{{ detection.detection_id }}</strong>
                  <span style="float: right; font-size: 12px; color: #666;">
                                         {% if confidence >= 0.3 %}
                       ğŸ”´ é«˜ä¿¡é ¼åº¦
                     {% elif confidence >= 0.2 %}
                       ğŸŸ¡ ä¸­ä¿¡é ¼åº¦
                     {% else %}
                       ğŸŸ¢ ä½ä¿¡é ¼åº¦
                     {% endif %}
                  </span><br>
                  <div class="coordinates">
                    ğŸ“ ç·¯åº¦: {{ "%.6f"|format(detection.latitude) }}<br>
                    ğŸ“ çµŒåº¦: {{ "%.6f"|format(detection.longitude) }}<br>
                    ğŸ¯ ä¿¡é ¼åº¦: {{ "%.3f"|format(confidence) }}
                  </div>
                </div>
              {% endfor %}
            {% else %}
              <div class="no-detection">
                <strong>ğŸ” æ¤œå‡ºçµæœ</strong><br>
                ã“ã®åœ°åŸŸã‹ã‚‰ã¯å¤å¢³ã®å€™è£œåœ°å½¢ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚
              </div>
            {% endif %}
            
            <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <details style="margin-top: 20px;">
              <summary style="cursor: pointer; color: #666; font-weight: bold;">ğŸ”§ ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆé–‹ç™ºè€…ç”¨ï¼‰</summary>
              <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 10px; font-family: monospace; font-size: 12px;">
                <strong>åº§æ¨™ç¯„å›²:</strong><br>
                ç·¯åº¦: {{ result_info.debug_info.lat_range if result_info.debug_info.lat_range else "N/A" }}<br>
                çµŒåº¦: {{ result_info.debug_info.lon_range if result_info.debug_info.lon_range else "N/A" }}<br><br>
                
                <strong>æ¤œå‡ºãƒ•ã‚¡ã‚¤ãƒ«:</strong><br>
                {{ result_info.debug_info.found_txt_files if result_info.debug_info.found_txt_files else "ãªã—" }}<br><br>
                
                {% if result_info.debug_info.raw_detections %}
                  <strong>ç”Ÿæ¤œå‡ºãƒ‡ãƒ¼ã‚¿:</strong><br>
                  {% for detection in result_info.debug_info.raw_detections %}
                    {{ detection }}<br>
                  {% endfor %}
                {% endif %}
                
                {% if result_info.debug_info.error %}
                  <strong style="color: red;">ã‚¨ãƒ©ãƒ¼:</strong><br>
                  {{ result_info.debug_info.error }}
                {% endif %}
              </div>
            </details>
          </div>
        {% endif %}
      </div>
    {% endif %}

    {% if error %}
      <div class="error">
        <strong>ã‚¨ãƒ©ãƒ¼:</strong> {{ error | safe }}
      </div>
    {% endif %}
  </div>

  <script>
    document.getElementById('xmlFile').addEventListener('change', function() {
      var img = document.querySelector('.result-image');
      var resultSection = document.querySelector('.result-section');
      if (img) img.style.display = 'none';
      if (resultSection) resultSection.style.display = 'none';
    });

    function onSubmitForm() {
      document.getElementById('loading-message').style.display = 'block';
      return true;
    }
  </script>
</body>
</html>
